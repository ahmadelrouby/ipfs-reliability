package test

import (
	"encoding/json"
	"fmt"
	ipfsconnector "ipfs-alpha-entanglement-code/ipfs-connector"
	"ipfs-alpha-entanglement-code/performance"
	"log"
	"math/rand"
	"strings"
	"testing"
	"time"

	"github.com/stretchr/testify/require"
)

func Test_Only_Data_Loss(t *testing.T) {
	var allRates []string
	var allOverhead []string
	var accuRate float32
	var accuOverhead float32

	onlyData := func(missNum int, fileinfo performance.FileInfo, try int) func(*testing.T) {
		return func(*testing.T) {
			conn, err := ipfsconnector.CreateIPFSConnector(0)
			require.NoError(t, err)

			// download metafile
			data, err := conn.GetFileToMem(fileinfo.MetaCID)
			require.NoError(t, err)
			var metaData performance.Metadata
			err = json.Unmarshal(data, &metaData)
			require.NoError(t, err)

			// create getter
			getter, err := performance.CreateRecoverGetter(conn, metaData.DataCIDIndexMap, metaData.ParityCIDs)
			require.NoError(t, err)

			// generate random miss and repeat tests
			for i := 0; i < try; i++ {
				indexes := make([]int, fileinfo.TotalBlock)
				for j := 0; j < fileinfo.TotalBlock; j++ {
					indexes[j] = j + 1
				}
				missedIndexes := map[int]struct{}{}
				for j := 0; j < missNum; j++ {
					r := int(rand.Int63n(int64(len(indexes))))
					missedIndexes[indexes[r]] = struct{}{}
					indexes[r], indexes[len(indexes)-1] = indexes[len(indexes)-1], indexes[r]
					indexes = indexes[:len(indexes)-1]
				}
				getter.DataFilter = missedIndexes

				result := performance.Recovery(fileinfo, metaData, getter)
				accuRate += result.RecoverRate
				accuOverhead += result.DownloadParity
			}

		}
	}

	key := "25MB"
	try := 100
	rand.Seed(time.Now().UnixNano())
	for i := 0; i <= performance.InfoMap[key].TotalBlock; i++ {
		accuRate = 0
		accuOverhead = 0
		t.Run(fmt.Sprintf("test_%d", i), onlyData(i, performance.InfoMap[key], try))

		allRates = append(allRates, fmt.Sprintf("%.4f", accuRate/float32(try)))
		allOverhead = append(allOverhead, fmt.Sprintf("%.4f", float32(accuOverhead)/(float32(try))))
	}

	// 25MB
	// Success Rate: [1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000]
	// Overhead: [0.0000,1.9500,3.8900,5.8000,7.6800,9.6100,11.5200,13.3000,15.0400,16.7800,18.6200,20.1700,22.2100,23.8700,25.5900,27.4100,29.0200,30.6200,32.3600,33.8400,35.3100,37.0200,38.5000,40.0700,41.7000,43.2500,44.1300,46.0200,47.3600,49.0400,50.3500,51.6200,53.0100,54.6500,55.6700,56.4400,58.2700,59.9000,60.3800,61.9500,63.1400,64.5400,65.2600,66.3900,68.0000,68.2300,70.4200,71.1100,72.4000,73.3400,74.4000,75.2700,75.8300,76.8900,78.6100,79.0700,80.3800,80.9300,82.1700,82.5800,83.5800,84.8300,84.9900,85.7900,86.5500,87.3600,88.0900,89.1100,89.5700,90.0100,90.7900,91.0200,91.7400,92.6200,92.6700,93.8400,93.9600,94.3500,94.8900,95.5400,96.0400,96.2800,96.6000,97.1400,97.5000,97.9200,98.1700,98.3700,98.8400,99.3400,99.4200,99.6800,99.8600,100.0600,100.1800,100.4700,100.5300,100.6500,100.8100,100.8700,100.9800,101.0000]
	log.Println("Success Rate: [" + strings.Join(allRates, ",") + "]")
	log.Println("Overhead: [" + strings.Join(allOverhead, ",") + "]")
}

func Test_Only_Parity_Loss(t *testing.T) {
	var partialRates []string
	var fullRates []string
	var allOverhead []string

	onlyParity := func(missNum int, fileinfo performance.FileInfo, iteration int) func(*testing.T) {
		return func(*testing.T) {
			result := performance.RecoverWithFilter(fileinfo, missNum, iteration, 0)
			partialRates = append(partialRates, fmt.Sprintf("%.4f", result.RecoverRate))
			fullRates = append(fullRates, fmt.Sprintf("%.4f", result.FullSuccessCnt))
			allOverhead = append(allOverhead, fmt.Sprintf("%.4f", result.DownloadParity))
		}
	}

	key := "125MB"
	try := 100
	rand.Seed(time.Now().UnixNano())
	for i := 1120; i <= performance.InfoMap[key].TotalBlock*3; i += 5 {
		t.Run(fmt.Sprintf("test_%d", i), onlyParity(i, performance.InfoMap[key], try))
		log.Println("Success Partial Recovery Rate: [" + strings.Join(partialRates, ",") + "]")
		log.Println("Success Full Recovery Rate: [" + strings.Join(fullRates, ",") + "]")
		log.Println("Overhead: [" + strings.Join(allOverhead, ",") + "]")
	}

	// 5MB
	// Success Partial Recovery Rate: [1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,0.9995,1.0000,0.9990,0.9990,0.9581,0.9686,0.9152,0.9448,0.9352,0.8438,0.8267,0.8386,0.7148,0.7614,0.5838,0.5919,0.4257,0.3933,0.3886,0.3081,0.2514,0.1262,0.1586,0.0633,0.0833,0.0471,0.0305,0.0400,0.0210,0.0186,0.0152,0.0171,0.0090,0.0067,0.0024,0.0019,0.0014,0.0014,0.0000,0.0000,0.0000]
	// Success Full Recovery Rate: [1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,0.9900,1.0000,0.9800,0.9800,0.9200,0.9400,0.8400,0.8500,0.8600,0.7700,0.6600,0.6900,0.4500,0.5200,0.2300,0.2200,0.1400,0.0500,0.0100,0.0100,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000]
	// Memory Overhead: [21.0000,21.6600,22.4300,22.9700,23.4700,24.2300,24.8800,25.4900,27.9300,28.7100,31.1700,32.0300,33.4500,34.8500,36.2700,38.8600,39.8300,39.7700,43.4800,43.8700,44.8300,46.1600,48.0300,47.8200,48.1800,47.9400,48.4200,48.4100,48.5400,47.3400,48.0200,47.5200,46.1000,45.3900,44.2500,41.7500,42.6700,38.6700,38.6900,33.5800,31.6100,30.6400,27.6800,25.6100,22.2700,21.1400,19.0100,17.8200,16.0800,14.8600,13.7100,12.5600,11.3900,10.3300,9.1500,8.1700,7.1300,6.0300,5.0000,4.0100,3.0000,2.0000,1.0000,0.0000]
	// Download Overhead: [21.0000,21.1700,21.2700,21.4600,21.5700,21.5600,21.8800,21.9500,22.6200,22.9100,23.5700,23.2900,23.6700,24.2200,24.5600,24.4200,25.1200,27.2900,29.3500,28.9300,30.9200,29.9300,31.5200,31.1500,31.0100,31.6300,32.3200,32.3400,32.9800,31.6100,31.2800,30.6600,30.3100,29.2800,28.3200,27.6400,26.7900,25.8200,24.8600,23.9100,22.9000,21.9600,20.8800,19.9300,19.0000,17.9900,16.9900,15.9600,14.9900,13.9900,12.9900,12.0000,11.0000,10.0000,9.0000,8.0000,7.0000,6.0000,5.0000,4.0000,3.0000,2.0000,1.0000,0.0000]

	// 25MB
	// Success Partial Recovery Rate: [1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,0.9999,1.0000,1.0000,1.0000,1.0000,1.0000,0.9999,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,0.9900,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,0.9897,0.9900,0.9999,0.9998,0.9900,0.9997,1.0000,0.9997,0.9999,0.9998,0.9898,1.0000,0.9997,0.9999,0.9898,0.9997,0.9799,0.9899,0.9798,0.9897,0.9894,0.9997,0.9998,1.0000,0.9998,0.9796,0.9894,0.9898,0.9900,0.9899,0.9588,0.9989,0.9684,0.9784,0.9887,0.9685,0.9887,0.9888,0.9775,0.9684,0.9673,0.9556,0.9740,0.9766,0.9554,0.9373,0.9550,0.9246,0.9451,0.9539,0.9323,0.9446,0.9237,0.9230,0.8821,0.8819,0.9294,0.8848,0.8544,0.8907,0.8537,0.8560,0.8613,0.8208,0.7748,0.8843,0.7563,0.8108,0.7401,0.7995,0.8289,0.7634,0.6887,0.7375,0.7648,0.6922,0.6605,0.6305,0.6380,0.6273,0.5539,0.5536,0.5641,0.5438,0.4906,0.5430,0.5111,0.5226,0.4372,0.3892,0.3572,0.3562,0.3977,0.2898,0.3410,0.3508,0.2874,0.2588,0.2882,0.2564,0.2783,0.2409,0.2557,0.1945,0.2237,0.2251,0.1877,0.1913,0.1716,0.1658,0.1537,0.1320,0.1661,0.1074,0.1461,0.0830,0.0850,0.1224,0.1087,0.0766,0.0924,0.0971,0.0877,0.0773,0.0801,0.0757,0.0829,0.0569,0.0524,0.0508,0.0553,0.0436,0.0485,0.0422,0.0296,0.0251,0.0330,0.0293,0.0319,0.0195,0.0375,0.0242,0.0207,0.0190,0.0188,0.0169,0.0171,0.0094,0.0207,0.0121,0.0107,0.0043,0.0104,0.0188,0.0147,0.0086,0.0077,0.0127,0.0076,0.0084,0.0127,0.0051,0.0053,0.0049,0.0065,0.0044,0.0054,0.0038,0.0016,0.0043,0.0029,0.0012,0.0022,0.0016,0.0017,0.0012,0.0021,0.0011,0.0016,0.0000,0.0004,0.0008,0.0000,0.0005,0.0000,0.0003,0.0002,0.0001,0.0000,0.0004,0.0000,0.0001,0.0000,0.0002,0.0003,0.0002,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000]
	// Success Full Recovery Rate: [1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,0.9900,1.0000,1.0000,1.0000,1.0000,1.0000,0.9900,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,0.9900,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,0.9600,0.9900,0.9900,0.9900,0.9900,0.9700,1.0000,0.9700,0.9900,0.9800,0.9700,1.0000,0.9700,0.9900,0.9700,0.9700,0.9700,0.9800,0.9600,0.9600,0.9600,0.9700,0.9800,1.0000,0.9800,0.9400,0.9300,0.9700,0.9900,0.9800,0.8700,0.9000,0.8500,0.9300,0.8800,0.9000,0.9300,0.8900,0.9000,0.8600,0.8400,0.8300,0.7800,0.7900,0.7700,0.8100,0.8100,0.7400,0.7400,0.7800,0.7100,0.7100,0.6800,0.6700,0.6200,0.6200,0.6300,0.5300,0.5100,0.5500,0.5900,0.4800,0.4000,0.4400,0.3100,0.4800,0.3200,0.2800,0.3000,0.2300,0.2800,0.2100,0.1600,0.1200,0.1500,0.1800,0.0500,0.1000,0.1000,0.0200,0.0400,0.0500,0.0100,0.0100,0.0100,0.0200,0.0200,0.0100,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000]
	// Memory Overhead: [101.0000,101.8600,103.0500,103.9800,104.8900,105.7700,106.9000,107.3600,107.9100,109.8600,110.3600,111.5500,111.3800,113.1100,113.9100,115.0100,116.0000,115.7400,117.8100,118.0900,119.8000,120.7700,121.9200,122.6300,124.2300,125.9800,127.4400,126.8200,127.5900,129.7300,131.3600,134.1000,135.0700,134.1400,137.9800,137.4000,140.3900,140.2400,142.4800,143.1100,146.8600,145.7100,150.3600,150.2500,152.4900,154.1300,153.3200,159.9000,162.0800,160.2200,164.2300,165.1200,166.1800,169.8800,170.5900,172.5700,174.4800,178.4300,179.4500,183.3100,180.6100,185.1900,187.5200,190.1900,193.7400,193.8000,197.6800,196.2900,198.6400,202.8200,202.8500,202.9200,207.5000,209.6700,208.6500,210.2300,213.7900,214.8900,215.3600,220.0600,218.4900,220.6800,222.5500,225.3500,226.1300,230.4500,228.5000,231.7600,234.9500,233.8900,233.1200,234.5900,236.0800,237.2300,238.9700,238.3400,241.6400,242.0000,243.1200,244.3000,246.3400,243.5300,248.6300,249.4100,247.5200,249.9000,252.5600,251.5100,254.7200,255.8800,251.6200,258.3600,258.8200,259.4900,255.2500,260.3000,259.4400,261.4900,259.1500,263.5500,261.4900,264.2000,263.0200,265.5400,265.3600,262.6600,265.0600,263.9900,267.8900,268.5800,264.1700,268.9900,266.8500,270.3700,269.2600,268.7400,271.4900,270.6800,270.5000,269.8500,270.5400,269.7000,271.6400,272.5100,271.3900,269.5200,272.0500,269.0300,270.3100,272.8300,270.8700,273.1700,270.8600,272.9000,267.6500,269.0300,272.7500,269.3500,266.8800,268.7100,267.6900,266.9400,268.7800,264.4900,258.6700,267.9400,261.9900,263.4400,258.9600,261.1500,264.6700,256.1000,250.5600,255.3600,256.4200,247.2900,246.2900,242.6800,240.8200,239.6200,231.4300,228.8300,219.7200,227.7300,216.5500,215.9800,213.8100,211.1900,199.8200,194.0600,190.9600,190.8700,188.0000,178.5200,179.7100,174.4200,167.8600,166.0100,164.2800,157.3900,158.1900,153.4600,150.6300,145.5300,143.0600,144.5100,138.2000,137.6600,135.6300,130.5000,128.3700,125.5500,125.8500,120.0900,120.6200,116.7300,113.8200,112.8700,111.0800,108.3100,107.2000,104.7900,103.5200,100.7600,99.1200,97.4300,94.9400,93.7800,91.6500,88.8200,88.0800,87.1700,85.6300,84.3400,81.7500,80.0900,78.4900,76.3800,75.3200,73.6600,72.4700,70.8600,69.8100,68.0500,66.5600,65.3300,63.4100,62.7000,61.5500,59.6400,58.5400,56.7200,56.2200,54.7700,53.2900,51.9400,50.6100,49.4100,48.2700,47.1800,45.9100,44.6800,43.2400,42.4200,41.2100,39.7600,38.8600,37.4700,36.3400,35.3800,34.3100,33.1800,31.9300,30.9500,29.9200,28.6500,27.5300,26.5100,25.4200,24.4600,23.3600,22.4500,21.3500,20.2100,19.2300,18.1400,17.1700,16.1400,15.0800,14.0400,13.0300,12.0400,11.0100,10.0200,9.0000,8.0000,7.0000,6.0000,5.0000,4.0000,3.0000,2.0000,1.0000,0.0000]
	// Download Overhead: [101.0000,101.3600,101.5800,101.8000,102.1100,102.4800,102.8400,103.0700,103.5100,103.5700,103.9700,104.3100,104.4200,105.2200,105.0100,105.3000,105.6000,105.7500,106.3000,106.6900,106.8200,107.1700,108.2000,107.7400,108.6800,109.3700,109.0100,110.2300,109.4800,110.2600,111.3200,110.4700,111.9100,112.1400,112.2500,113.6300,113.6800,113.4900,113.3300,115.7400,115.6900,115.9500,115.9200,117.5100,117.2900,117.4900,118.8500,120.4700,120.8500,120.8600,121.1200,121.8700,122.1000,125.2300,124.4000,124.1500,125.0100,127.4700,127.4400,126.8000,129.2700,128.4300,129.6700,131.0100,134.0500,133.7400,135.3700,138.2800,135.4900,137.9400,138.5100,137.7800,141.4500,140.2400,142.9300,143.7900,143.7200,143.2500,145.6700,148.3300,146.6800,147.3300,149.3900,151.6100,152.8400,152.4100,154.2800,154.3300,153.4100,154.8100,157.5600,153.9700,155.6900,157.4400,158.4700,157.8600,159.1800,158.8000,160.6200,159.1700,160.1500,159.9700,160.1000,161.8600,160.8600,164.5200,161.6500,163.5100,165.2600,162.7000,163.8300,165.6500,162.5700,163.9200,161.1200,163.9000,163.7300,165.3600,163.5700,163.6300,162.8400,162.1900,163.2700,162.7500,163.5100,162.8400,162.3300,162.9200,163.2400,162.3300,159.9800,160.7400,159.1600,159.4800,160.1100,159.6800,155.9800,157.0900,157.1800,157.1300,156.2700,155.6000,153.7600,153.2100,153.6100,152.4100,152.3400,151.4600,150.0100,150.5800,149.4200,148.2900,147.6400,146.7600,145.8600,145.2400,144.5400,143.7200,142.0400,141.8300,140.6600,140.6000,139.6400,137.7600,137.8000,136.7800,135.8500,134.4600,133.9000,132.9700,131.8500,131.1300,130.3700,129.1800,128.3500,127.3200,126.4200,125.4700,124.6900,123.5800,121.8800,121.6400,119.7000,119.7300,118.8200,117.7900,116.6700,115.7400,114.7600,113.7600,112.7600,111.8000,110.8000,109.8400,108.7100,107.8500,106.8900,105.9200,104.9000,103.9700,102.8500,101.9200,100.8800,99.8400,98.9200,97.9100,96.9900,95.9500,94.9500,93.9500,92.9900,91.9800,90.9500,89.9300,88.9900,87.9500,86.9800,85.9400,84.9500,83.9700,82.9800,82.0000,80.9700,79.9800,78.9800,77.9800,76.9900,75.9600,74.9900,74.0000,72.9900,71.9900,71.0000,69.9800,69.0000,67.9900,66.9900,65.9900,65.0000,63.9800,62.9900,61.9700,60.9800,59.9900,59.0000,58.0000,56.9900,56.0000,55.0000,54.0000,53.0000,52.0000,51.0000,50.0000,49.0000,48.0000,47.0000,45.9900,45.0000,44.0000,43.0000,41.9900,41.0000,40.0000,39.0000,38.0000,37.0000,36.0000,35.0000,34.0000,33.0000,32.0000,31.0000,30.0000,29.0000,28.0000,27.0000,26.0000,25.0000,24.0000,23.0000,22.0000,21.0000,20.0000,19.0000,18.0000,17.0000,16.0000,15.0000,14.0000,13.0000,12.0000,11.0000,10.0000,9.0000,8.0000,7.0000,6.0000,5.0000,4.0000,3.0000,2.0000,1.0000,0.0000]

	// 125MB
	// Success Partial Recovery Rate: [1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,0.9965,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,0.9965,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,0.9999,0.9999,1.0000,0.9998,1.0000,1.0000,0.9965,1.0000,1.0000,0.9999,0.9999,0.9999,0.9999,0.9999,0.9964,0.9964,1.0000,0.9861,0.9997,0.9999,0.9996,0.9996,0.9999,0.9997,0.9925,0.9994,0.9995,0.9962,0.9689,0.9992,0.9962,0.9763,0.9794,0.9919,0.9890,0.9859,0.9720,0.9878,0.9554,0.9877,0.9808,0.9682,0.9572,0.9285,0.9642,0.9522,0.9345,0.9199,0.9794,0.9149,0.9009,0.9322,0.8926,0.8876,0.9044,0.8788,0.8457,0.8474,0.8845,0.8218,0.8104,0.8395,0.8552,0.8578,0.7929,0.7770,0.7581,0.7059,0.6933,0.6790,0.6986,0.7325,0.6721,0.6851,0.6374,0.5850,0.5750,0.5201,0.5197,0.5361,0.5228,0.5089,0.4338,0.3881,0.4085,0.4136,0.3825,0.3669,0.4005,0.3815,0.3090,0.3144,0.2855,0.3186,0.2587,0.2322,0.2112,0.1719,0.2019,0.1358,0.1460,0.1070,0.1397,0.1171,0.1060,0.1016,0.0946,0.0696,0.0607,0.0784,0.0861,0.0574,0.0495,0.0376,0.0641,0.0561,0.0521,0.0506,0.0452,0.0281,0.0337,0.0286,0.0298,0.0298,0.0290,0.0211,0.0086,0.0161,0.0068,0.0130,0.0110,0.0095,0.0138,0.0053,0.0100,0.0083,0.0033,0.0024,0.0095,0.0078,0.0031,0.0048,0.0074,0.0027,0.0015,0.0035,0.0023,0.0035,0.0016,0.0026,0.0009,0.0014,0.0017,0.0013,0.0017,0.0015,0.0015,0.0022,0.0003,0.0013,0.0001,0.0008,0.0005,0.0004,0.0008,0.0001,0.0005,0.0001,0.0001,0.0003,0.0000,0.0002,0.0004,0.0003,0.0001,0.0001,0.0001,0.0002,0.0000,0.0001,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0001,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000]
	// Success Full Recovery Rate: [1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,0.9900,1.0000,0.9900,1.0000,0.9900,0.9900,0.9900,1.0000,0.9900,0.9900,1.0000,0.9900,1.0000,0.9900,1.0000,0.9900,0.9900,0.9900,0.9900,0.9700,0.9600,1.0000,0.9800,0.9900,0.9800,0.9700,0.9900,0.9800,0.9500,0.9500,0.9700,0.9300,0.9700,0.9500,0.9500,1.0000,0.8800,0.9100,0.9300,0.8800,0.9200,0.9600,0.9100,0.9100,0.8800,0.8500,0.8200,0.7900,0.8000,0.8300,0.8600,0.8000,0.7500,0.8100,0.7500,0.6900,0.7000,0.6200,0.5600,0.6200,0.6400,0.5700,0.5900,0.5600,0.4100,0.3900,0.3900,0.4300,0.2900,0.3200,0.2100,0.1800,0.2800,0.2400,0.2100,0.2300,0.1900,0.1600,0.1100,0.0800,0.1100,0.0400,0.0800,0.0400,0.0400,0.0400,0.0200,0.0000,0.0100,0.0000,0.0100,0.0000,0.0000,0.0000,0.0100,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000]
	// Memory Overhead: [504.0000,508.2300,510.3600,513.5800,516.1800,520.5100,523.9000,527.3000,530.6300,535.0200,537.9500,541.4900,544.4300,548.0100,550.0500,555.5400,559.1300,563.7000,565.3000,568.7800,572.3800,577.7700,580.0100,586.7200,589.2700,594.8900,600.6800,602.6200,606.3900,611.0800,616.1800,620.4500,622.8100,627.3300,632.0100,641.7500,646.1900,651.5700,656.6300,657.7400,661.0900,669.2300,671.5700,676.7100,684.4700,697.1800,696.0600,704.4100,710.3500,718.6100,729.9600,732.1400,748.5200,747.9900,760.3700,757.8000,768.5900,784.2600,787.7100,791.9900,797.5500,803.2400,816.1900,824.6800,830.4200,846.5900,855.0400,864.5500,869.4700,880.0900,881.1500,904.1100,908.6800,922.1400,929.0400,938.9500,941.5500,956.6600,970.2400,982.1700,980.8200,995.4700,999.9600,1015.8400,1015.9100,1025.3500,1032.6801,1047.9100,1053.1000,1061.6300,1076.4100,1075.1400,1087.8400,1093.3300,1102.4000,1115.6600,1119.4500,1122.6200,1129.9301,1140.2200,1142.4200,1149.8800,1164.2800,1162.8300,1179.2000,1177.1200,1193.1100,1195.9000,1199.7100,1198.3400,1213.6100,1217.9500,1208.4600,1231.5200,1233.7800,1243.3300,1236.5900,1253.1100,1255.7700,1255.2400,1268.2700,1274.0000,1272.9500,1248.8400,1284.7500,1295.2500,1282.7500,1285.3700,1297.7800,1308.1300,1299.8000,1293.7400,1316.5699,1280.0100,1337.1801,1337.7100,1325.0500,1319.1000,1285.8700,1326.7400,1331.1300,1314.2800,1303.3101,1359.5601,1314.0100,1313.1500,1337.1700,1285.3600,1309.8700,1300.0900,1293.2900,1276.4600,1287.4800,1306.5800,1249.0000,1279.7800,1292.6300,1299.3600,1270.1300,1274.9700,1256.3400,1230.8500,1210.9301,1173.6801,1164.0200,1191.8400,1204.0000,1192.0800,1175.3700,1178.9000,1117.1000,1122.0300,1106.5400,1092.0400,1096.8300,1100.2100,1071.5601,1022.7600,1039.6200,1044.1100,1046.3900,1006.2100,998.2400,1002.8300,1009.1700,958.2800,958.6300,902.0400,963.3700,857.6800,932.2600,846.4700,808.8200,866.9800,779.8500,804.2600,771.8700,775.9500,742.6100,743.6100,739.4400,729.5600,724.2800,710.9600,691.9000,693.2300,660.9100,663.4400,653.1200,661.4200,642.9600,630.1100,624.0700,603.1500,596.0300,585.7700,569.7000,559.4400,556.7700,546.3600,536.1100,527.5700,517.5300,508.9500,497.8100,490.4200,483.5800,470.4200,462.1400,454.5300,443.6800,433.1400,427.6900,420.3400,411.2800,403.0700,390.0900,387.9800,379.4700,368.9000,362.1300,357.4900,347.5000,341.2400,335.0300,325.6100,319.8000,312.1600,305.2600,297.7300,291.7000,284.6400,277.9100,272.6200,264.8400,258.1800,251.9500,245.2100,239.7000,233.9500,227.0800,221.2800,215.4200,210.1300,203.1700,197.7900,191.5900,186.1000,180.1400,174.3900,168.9700,162.8200,158.2100,152.0100,146.5600,140.9500,135.4700,130.2800,124.7700,119.5800,114.3300,109.0400,103.8500,98.3700,93.1200,88.0800,82.9600,77.8200,72.4700,67.4700,62.2800,57.3400,52.2400,47.1700,42.1300,37.0400,32.0200,27.0300,22.0000,17.0000,12.0000,7.0000,2.0000,0.0000]
	// Download Overhead: [504.0000,505.5900,506.9900,508.7900,510.6200,512.3300,513.9400,515.3700,517.1800,519.2200,520.6300,522.0500,524.2200,525.5100,528.0700,529.5100,530.5700,532.1000,534.1800,536.8100,537.2500,540.1700,541.9700,544.2500,545.4400,547.2400,550.0400,551.4500,552.7200,556.5500,557.7000,561.5100,563.1100,564.6800,569.1600,570.7400,572.9600,575.0000,578.9800,581.1300,582.5500,587.0700,590.4000,592.6000,595.3400,600.0900,602.7700,606.9600,609.9100,615.6900,621.1400,619.9500,626.8000,630.2900,630.0800,635.6600,644.8100,641.2300,653.7400,652.7200,659.2300,667.0600,668.7300,675.2700,680.7900,686.4300,690.6800,693.8800,698.2400,702.2800,708.1600,712.6300,719.5600,726.4400,722.1500,731.6900,736.2100,735.2800,745.5000,746.4700,751.7700,756.4200,759.9200,763.4100,765.2000,768.7200,778.3800,778.5900,785.2500,785.1300,791.4600,791.0700,791.3600,798.8500,803.5400,806.7600,807.8200,808.8500,812.7400,811.6800,809.9800,815.1900,821.5300,816.9100,823.0400,820.6000,823.0400,824.0800,828.0500,818.1200,829.9200,824.8600,825.8300,821.8800,828.3100,826.7000,826.2600,826.3100,824.9800,817.9400,821.0000,823.7800,815.5700,820.4300,804.3100,808.9900,809.0300,815.3600,798.9200,788.0500,796.6100,778.1700,802.2800,795.9400,784.8300,773.0700,788.0400,768.7100,780.3700,784.0300,759.6100,772.2700,770.3300,754.1500,762.7700,746.4600,725.8700,721.6600,704.6800,708.2800,678.8100,722.4000,700.1300,715.9600,675.0600,674.2900,659.2900,637.4800,669.4500,647.4300,646.8800,674.1400,624.6300,642.9400,625.0800,581.3300,612.5700,541.3300,559.2600,553.0400,579.1900,549.7500,578.4800,574.2100,548.6600,539.5700,522.4900,509.4000,544.7000,536.7100,500.6600,532.7800,521.4500,530.1500,514.7200,523.4900,502.9300,530.5800,512.7600,505.5600,519.1000,505.8800,498.6200,493.3500,488.0500,492.7000,474.2000,474.2200,484.5400,482.5500,491.2000,464.9400,481.2900,474.2100,472.8700,477.4400,464.5800,461.3600,468.5300,454.2400,450.5500,446.0900,443.8700,443.6600,435.6300,431.6900,425.4300,415.0400,415.8400,416.5500,407.9000,406.5800,401.7300,396.6000,388.6000,386.1100,381.5600,377.0000,372.0000,365.8100,361.9900,357.0000,350.4100,347.0000,342.0000,336.7400,331.8000,327.0000,321.1600,316.9900,311.9900,307.0000,302.0000,297.0000,292.0000,287.0000,282.0000,277.0000,271.9900,267.0000,262.0000,257.0000,252.0000,247.0000,242.0000,237.0000,232.0000,227.0000,222.0000,217.0000,212.0000,207.0000,202.0000,197.0000,192.0000,187.0000,182.0000,177.0000,172.0000,167.0000,162.0000,157.0000,152.0000,147.0000,142.0000,137.0000,132.0000,127.0000,122.0000,117.0000,112.0000,107.0000,102.0000,97.0000,92.0000,87.0000,82.0000,77.0000,72.0000,67.0000,62.0000,57.0000,52.0000,47.0000,42.0000,37.0000,32.0000,27.0000,22.0000,17.0000,12.0000,7.0000,2.0000,0.0000]
	log.Println("Success Partial Recovery Rate: [" + strings.Join(partialRates, ",") + "]")
	log.Println("Success Full Recovery Rate: [" + strings.Join(fullRates, ",") + "]")
	log.Println("Overhead: [" + strings.Join(allOverhead, ",") + "]")
}

func Test_Only_Parity_Loss_Node_Loss(t *testing.T) {
	var partialRates []string
	var fullRates []string
	var allOverhead []string
	nbNodes := 10

	onlyParity := func(missNum int, fileinfo performance.FileInfo, iteration int) func(*testing.T) {
		return func(*testing.T) {
			result := performance.RecoverWithFilter(fileinfo, missNum, iteration, nbNodes)
			partialRates = append(partialRates, fmt.Sprintf("%.4f", result.RecoverRate))
			fullRates = append(fullRates, fmt.Sprintf("%.4f", result.FullSuccessCnt))
			allOverhead = append(allOverhead, fmt.Sprintf("%.4f", result.DownloadParity))
		}
	}

	key := "25MB"
	try := 100
	rand.Seed(time.Now().UnixNano())
	for i := 0; i <= nbNodes; i++ {
		t.Run(fmt.Sprintf("test_%d", i), onlyParity(i, performance.InfoMap[key], try))
	}

	// Node = 10
	// Success Partial Recovery Rate: [1.0000,1.0000,1.0000,0.9999,0.9997,0.9971,0.8834,0.2716,0.0564,0.0031,0.0000]
	// Success Full Recovery Rate: [1.0000,1.0000,1.0000,0.9940,0.9700,0.9100,0.3840,0.0000,0.0000,0.0000,0.0000]
	// Memory Overhead: [101.0000,119.6180,143.8900,187.1860,229.9180,252.1760,246.6680,122.7520,64.6820,30.3160,0.0000]
	// Download Overhead: [101.0000,110.1260,121.4080,141.7600,156.2620,147.2200,120.6540,90.7260,60.4580,30.2760,0.0000]

	// Node = 20
	// Success Partial Recovery Rate: [1.0000,1.0000,1.0000,1.0000,0.9999,1.0000,0.9997,0.9997,0.9975,0.9933,0.9843,0.9430,0.8210,0.5219,0.2416,0.1209,0.0586,0.0242,0.0079,0.0015,0.0000]
	// Success Full Recovery Rate: [1.0000,1.0000,1.0000,1.0000,0.9940,0.9980,0.9660,0.9660,0.9440,0.9280,0.8400,0.6340,0.2880,0.0100,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000]
	// Memory Overhead: [101.0000,110.1080,119.5280,130.7960,146.8500,165.4800,196.8920,218.6420,240.7340,253.7420,259.7820,263.4640,251.6500,182.6140,118.1520,87.7700,64.9600,46.1760,30.3080,15.1540,0.0000]
	// Download Overhead: [101.0000,105.3600,109.8540,115.2480,122.7420,135.7980,147.4660,159.2000,161.6700,158.1180,148.0840,135.1160,120.6140,105.7040,90.6900,75.5800,60.5340,45.4120,30.3060,15.1700,0.0000]

	// Node = 50
	// Success Partial Recovery Rate: [1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,0.9999,1.0000,0.9999,0.9999,0.9999,0.9998,0.9999,0.9997,0.9997,0.9996,0.9994,0.9935,0.9974,0.9991,0.9928,0.9922,0.9880,0.9772,0.9691,0.9611,0.9105,0.8817,0.8187,0.6871,0.5142,0.4055,0.2984,0.2342,0.1950,0.1534,0.1164,0.0908,0.0637,0.0428,0.0368,0.0228,0.0181,0.0094,0.0072,0.0028,0.0015,0.0006,0.0000]
	// Success Full Recovery Rate: [1.0000,1.0000,1.0000,1.0000,1.0000,1.0000,0.9980,1.0000,0.9920,0.9960,0.9920,0.9940,0.9880,0.9800,0.9880,0.9720,0.9720,0.9640,0.9420,0.9460,0.9380,0.9140,0.8740,0.8420,0.8140,0.7840,0.6720,0.5900,0.4160,0.2920,0.1620,0.0380,0.0080,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000]
	// Memory Overhead: [101.0000,104.6140,108.3840,112.2540,116.1380,120.6380,125.2960,130.6340,135.9500,143.0300,149.8680,157.7780,170.3300,182.1760,192.8660,207.9240,217.2000,226.8620,234.7640,241.7020,247.2940,250.5500,256.0560,258.9340,261.0480,262.2400,266.0200,266.5740,264.3560,261.1880,251.2040,224.3840,185.1660,156.4340,135.8500,120.3300,106.8240,96.0040,85.3500,75.5740,67.0920,58.8600,51.7420,44.3740,37.5240,30.7760,24.4780,18.2180,12.1160,6.0580,0.0000]
	// Download Overhead: [101.0000,102.7200,104.4240,106.2600,108.0000,110.1700,112.3320,115.5620,117.6320,121.6520,125.8560,130.5300,137.4300,143.9800,149.2060,154.7640,158.5060,161.2660,163.1540,165.2100,164.7240,163.2220,160.1340,157.0960,152.7700,148.1640,143.1860,137.8140,132.1900,126.4400,120.5700,114.6400,108.7080,102.6420,96.6720,90.6400,84.6060,78.5740,72.5780,66.5340,60.4720,54.4780,48.3940,42.3600,36.3540,30.2880,24.2120,18.1840,12.1040,6.0600,0.0000]
	log.Println("Success Partial Recovery Rate: [" + strings.Join(partialRates, ",") + "]")
	log.Println("Success Full Recovery Rate: [" + strings.Join(fullRates, ",") + "]")
	log.Println("Overhead: [" + strings.Join(allOverhead, ",") + "]")
}
